<div class="issue-detail-container" *ngIf="!isLoading && !error && issue">
  <div class="header-row">
    <button class="back-button" (click)="goBack()">← 戻る</button>
    <button class="edit-button" (click)="togglePopup()">編集</button>
  </div>

  <div class="issue-header">
    <h1>{{ issue.title }}</h1>
    <div class="issue-meta">
      <div class="meta-item">
        <span class="label">ステータス:</span>
        <span [class]="'status-badge ' + issue.status">
          {{ getStatusLabel(issue.status) }}
        </span>
      </div>

      <div class="meta-item">
        <span class="label">優先度:</span>
        <span class="form-value priority" [class]="'form-value priority ' + issue.priority">
          {{ getPriorityLabel(issue.priority) }}
        </span>
      </div>

      <div class="meta-item">
        <span class="label">担当者:</span>
        <span>
          {{ getMemberDisplayName(issue.assignee) }}
        </span>
      </div>

      <div class="meta-item">
        <span class="label">開始日:</span>
        <span>
          {{ issue.startDate ? (issue.startDate.toDate() | date:'yyyy/MM/dd') : '未設定' }}
        </span>
      </div>

      <div class="meta-item">
        <span class="label">期限:</span>
        <span>
          {{ issue.dueDate ? (issue.dueDate.toDate() | date:'yyyy/MM/dd') : '未設定' }}
        </span>
      </div>
      <div class="issue-description">
        <h3>メモ</h3>
        <p>{{ issue.memo }}</p>
      </div>
    </div>
  </div>


  <!-- Todo section -->
  <div class="todos-section">
    <h3>Todo一覧</h3>
    
    <!-- Todo追加フォーム -->
    <div class="todo-form">
      <input
        type="text"
        [(ngModel)]="newTodoTitle"
        placeholder="Todoを入力"
        class="todo-input"
      >
      <input
        type="datetime-local"
        [(ngModel)]="newTodoDueDate"
        class="todo-date"
      >
      <select
        [(ngModel)]="newTodoAssignee"
        class="todo-assignee"
      >
        <option value="">担当者を選択</option>
        <option [value]="member.uid" *ngFor="let member of memberDetails">
          {{ member.displayName }}
        </option>
      </select>
      <button
        (click)="addTodo()"
        [disabled]="!newTodoTitle || !newTodoAssignee"
        class="add-todo-btn"
      >
        追加
      </button>
    </div>

    <!-- Todoリスト -->
    <div class="todo-list">
      <div *ngFor="let todo of todos" class="todo-item">
        <input
          type="checkbox"
          [checked]="todo.completed"
          (change)="toggleTodo(todo)"
          class="todo-checkbox"
        >
        <span class="todo-title" [class.completed]="todo.completed">{{ todo.title }}</span>
        <div class="todo-meta">
          <span class="todo-assignee">
            <i class="fas fa-user"></i>
            {{ getMemberDisplayName(todo.assignee) }}
          </span>
          <span class="todo-due-date" *ngIf="todo.dueDate">
            <i class="fas fa-calendar"></i>
            {{ todo.dueDate ? (todo.dueDate.toDate() | date:'yyyy/MM/dd HH:mm') : '未設定' }}
          </span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ポップアップ -->
<div class="popup-overlay" *ngIf="isPopupVisible" (click)="togglePopup()">
  <div class="popup-content" (click)="$event.stopPropagation()">
    <div class="popup-header">
      <h2>課題の編集</h2>
      <button class="close-button" (click)="togglePopup()">×</button>
    </div>
    <div class="popup-body">
      <div class="popup-form">
        <div class="form-group">
          <label>タイトル</label>
          <input type="text" class="form-input" placeholder="タイトルを入力" [(ngModel)]="editingIssue.title">
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>優先度</label>
            <select class="form-input" [(ngModel)]="editingIssue.priority">
              <option value="">選択してください</option>
              <option value="high">高</option>
              <option value="medium">中</option>
              <option value="low">低</option>
            </select>
          </div>

          <div class="form-group">
            <label>担当者</label>
            <select class="form-input" [(ngModel)]="editingIssue.assignee">
              <option value="">選択してください</option>
              <option [value]="member.uid" *ngFor="let member of memberDetails">
                {{ member.displayName }}
              </option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>開始日</label>
            <input type="date" class="form-input" [(ngModel)]="editingIssue.startDate">
          </div>

          <div class="form-group">
            <label>期限日</label>
            <input type="date" class="form-input" [(ngModel)]="editingIssue.dueDate">
          </div>
        </div>

        <div class="form-group">
          <label>メモ</label>
          <textarea class="form-input" rows="3" placeholder="メモを入力" [(ngModel)]="editingIssue.memo"></textarea>
        </div>
      </div>
    </div>
    <div class="form-actions">
      <button class="save-button" (click)="saveIssue()">保存</button>
      <button class="cancel-button" (click)="togglePopup()">閉じる</button>
    </div>
  </div>
</div>

<div *ngIf="isLoading" class="loading">
  読み込み中...
</div>

<div *ngIf="error" class="error">
  {{ error }}
</div>
